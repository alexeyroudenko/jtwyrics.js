function LyricsItem(t,e,i){this.itemId=-1,this.state="forward",this.start=this.parseTime(t),this.end=this.parseTime(e),this.string=i,this.tweets=new Array,this.changed=!0}function Lyrics(t){this.lyrics=new Array,this.request=new XMLHttpRequest,this.request.open("GET",t,!0);var e=this;this.request.onload=function(){e.parse(this.responseText)},this.changed=!0}function Karaoke(){this.active=!0,this.doAnimation=!1,this.doSetDiv=!0}function anim(t){$("#lyrics_output").removeClass().addClass(t+" animated").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass()})}function TimeSimulator(t){"undefined"==t&&(t=0);var e=new Date;this.startTime=e.getTime()-1e3*t}function Tweets(t){this.lyrics=new Array,this.request=new XMLHttpRequest;var e=this;this.request.onload=function(){e.parse(this.responseText)},this.request.onerror=function(){e.onError()},this.request.open("GET",t,!0)}function Twyrics(t){0==t.hasOwnProperty("tweet_url")&&(t.tweet_url="http://api.proun.club/api/collections/"),0==t.hasOwnProperty("lyric_url")&&(t.lyric_url="lyrics.ass");document.getElementById("lyrics_output");document.getElementById("lyrics_output")||(console.log("create container"),this.container=document.createElement("div"),this.container.setAttribute("id","lyrics_output"),document.body.appendChild(this.container),document.getElementById("lyrics_output").style.zIndex="4000",document.getElementById("lyrics_output").style.position="absolute",document.getElementById("lyrics_output").style.fontSize="80px",document.getElementById("lyrics_output").style.padding="40px",document.getElementById("lyrics_output").style.margin="40px",document.getElementById("lyrics_output").style.color="white"),this.visible=!0,this.tweets=new Tweets(t.tweet_url),this.lyrics=new Lyrics(t.lyric_url),this.karaoke=new Karaoke;var e=this;this.lyrics.onComplete=function(){e.tweets.load()},this.tweets.onComplete=function(){e.lyrics.applyTweets(e.tweets.tweets),e.karaoke.setupw(e.lyrics),e.onReady(e.lyrics)},this.tweets.onError=function(){e.onError()},this.lyrics.load()}function TimeSimulator(){var t=new Date;this.startTime=t.getTime()}MAX_TWEET_PER_WORD=3,LyricsItem.prototype.parseTime=function(t){var e=t.split(":"),i=60*+e[0]*60+60*+e[1]+ +e[2];return i},LyricsItem.prototype.activate=function(t){this.state="active",this.changed=!0},LyricsItem.prototype.isCurrent=function(t){return"active"==this.state},LyricsItem.prototype.checkIsForward=function(t){return t<this.start},LyricsItem.prototype.checkIsFinish=function(t){return t>this.end},LyricsItem.prototype.checkIsCurrent=function(t){return t>this.start&&t<this.end},LyricsItem.prototype.update=function(t){if(this.checkIsForward(t)&&"forward"!=this.state)return this.state="forward",this.changed=!0,console.log("forward"),!0;if(this.checkIsFinish(t)&&"finish"!=this.state){this.state="finish",this.changed=!0;var e=document,i=document.createEvent("CustomEvent");return i.initCustomEvent("DeactivationEvent",!0,!0,{item:this}),e.dispatchEvent(i),!0}if(this.checkIsCurrent(t)&&"active"!=this.state){this.state="active",this.changed=!0;var e=document,i=document.createEvent("CustomEvent");return i.initCustomEvent("ActivationEvent",!0,!0,{item:this}),e.dispatchEvent(i),!0}this.changed=!1},Lyrics.prototype.load=function(){this.request.send()},Lyrics.prototype.parse=function(t){var e=t.split("\n"),s=0;for(i in e){var r=e[i].split(",");if(0==r[0].indexOf("Dialogue")){var o=r[1],n=r[2],c=r[9],a=new LyricsItem(o,n,c);a.itemId=s,this.lyrics.push(a),s++}}this.changed=!0,this.onComplete()},Lyrics.prototype.notify=function(t){console.log(t)},Lyrics.prototype.update=function(t){this.changed=!1;for(i in this.lyrics){var e=this.lyrics[i],s=e.update(t);s&&(this.onChange(e),this.changed=!0)}},Lyrics.prototype.formatted=function(){var t="";for(i in this.lyrics)"active"==this.lyrics[i].state&&(t+="<span class='active'>"),t+='<a href="#'+this.lyrics[i].itemId+'" onclick="showTweet('+this.lyrics[i].itemId+')">'+this.lyrics[i].string+"</a>","active"==this.lyrics[i].state&&(t+="</span>"),t+="<br>";return t},Lyrics.prototype.formattedActiveTweets=function(){var t="";for(i in this.lyrics)if("active"==this.lyrics[i].state)for(j in this.lyrics[i].tweets){var e=this.lyrics[i].tweets[j];t+=e.tweet_author+"<br>",t+=e.tweet_content+"<br>",t+=e.tweet_hashtags+"<br>",t+=e.tweet_time+"<br>",t+=e.tweet_url+"<br>"}return t},Lyrics.prototype.getNearest=function(){var t="",e=0;for(i in this.lyrics)0==e&&"forward"==this.lyrics[i].state&&(t=this.lyrics[i].string,e=1),0==e&&"active"==this.lyrics[i].state&&(t=this.lyrics[i].string,e=1);return t},Lyrics.prototype.formattedTweets=function(t){var e="";for(i in this.lyrics)if(this.lyrics[i].itemId==t)for(j in this.lyrics[i].tweets){var s=this.lyrics[i].tweets[j];e+=s.tweet_time+"&nbsp;",e+=s.tweet_author+"<br>",e+=s.tweet_content+"<br>",e+=s.tweet_hashtags+"<br>"}return e},Lyrics.prototype.applyTweets=function(t){var e=0;for(i in t.recent){var s=t.recent[i];for(j in this.lyrics){var r=this.lyrics[j];r.string.indexOf(s.word)!=-1&&(s.tweetId=s.tweet_timestamp,r.tweets.length<MAX_TWEET_PER_WORD&&(r.tweets.push(s),s.localId=e,e++))}}},Lyrics.prototype.onComplete=function(){console.log("Lyrics","onComplete")},Lyrics.prototype.onChange=function(t){},Lyrics.prototype.onError=function(){console.log("Lyrics","onError")},Karaoke.prototype.setupw=function(t){this.lyrics=t;var e=this,i=document;i.addEventListener("ActivationEvent",function(t){1==e.active&&e.showText(t.detail.item)},!1),i.addEventListener("DeactivationEvent",function(t){1==e.active&&e.hideText(t.detail.item)},!1)},Karaoke.prototype.showText=function(t){this.doSetDiv&&(document.getElementById("lyrics_output").innerHTML=t.string),this.doAnimation&&anim("flipInX")},Karaoke.prototype.hideText=function(t){this.doSetDiv&&(document.getElementById("lyrics_output").innerHTML="")},Karaoke.prototype.update=function(){},Karaoke.prototype.destroy=function(){document.getElementById("lyrics_output").innerHTML="",this.active=!1},TimeSimulator.prototype.start=function(t){"undefined"==t&&(t=0);var e=new Date;this.startTime=e.getTime()-1e3*t},TimeSimulator.prototype.getProgress=function(){var t=new Date;return(1e-5*(t.getTime()-this.startTime)).toFixed(2)},TimeSimulator.prototype.getTime=function(){var t=new Date;return(.001*(t.getTime()-this.startTime)).toFixed(2)},Tweets.prototype.load=function(){this.request.send()},Tweets.prototype.parse=function(t){this.tweets=JSON.parse(t),this.onComplete()},Tweets.prototype.onComplete=function(){console.log("Tweets","onComplete")},Tweets.prototype.onError=function(){console.log("Tweets","onComplete")},Tweets.prototype.onChange=function(t){console.log(t)},Twyrics.prototype.onError=function(t){console.log("onError",t)},Twyrics.prototype.onReady=function(t){console.log("onReady",t)},Twyrics.prototype.startSimulate=function(){console.log("simulate"),this.simulate=new TimeSimulator},Twyrics.prototype.update=function(t){$("#lyrics_output").css({visibility:this.visible?"visible":"hidden"}),this.simulate?this.lyrics.update(t):this.lyrics.update(t)},Twyrics.prototype.destroy=function(){this.karaoke.destroy()},TimeSimulator.prototype.getProgress=function(){var t=new Date;return(1e-5*(t.getTime()-this.startTime)).toFixed(2)},TimeSimulator.prototype.getTime=function(){var t=new Date;return(.001*(t.getTime()-this.startTime)).toFixed(2)};